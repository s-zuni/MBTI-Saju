// Vercel Serverless Function용 백엔드

const fetch = require('node-fetch');

// API 키 (Vercel 환경 변수로 설정하는 것이 안전하지만, 테스트용으로 직접 입력)
const OPENAI_API_KEY = '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';
const OPENAI_URL = 'https://api.openai.com/v1/chat/completions';

module.exports = async (req, res) => {
    // 1. CORS 설정 (모든 도메인 허용)
    res.setHeader('Access-Control-Allow-Credentials', true);
    res.setHeader('Access-Control-Allow-Origin', '*');
    res.setHeader('Access-Control-Allow-Methods', 'GET,OPTIONS,PATCH,DELETE,POST,PUT');
    res.setHeader(
        'Access-Control-Allow-Headers',
        'X-CSRF-Token, X-Requested-With, Accept, Accept-Version, Content-Length, Content-MD5, Content-Type, Date, X-Api-Version'
    );

    // OPTIONS 요청 처리 (Preflight)
    if (req.method === 'OPTIONS') {
        res.status(200).end();
        return;
    }

    // 2. POST 요청 처리
    if (req.method === 'POST') {
        const { name, gender, birth_date, birth_time, mbti } = req.body;

        if (!name || !gender || !birth_date || !birth_time || !mbti) {
            return res.status(400).json({ error: '필수 정보가 누락되었습니다.' });
        }

        const systemPrompt = `
        당신은 MBTI와 사주 명리학을 결합한 전문 컨설턴트입니다.
        생년월일시를 통해 사주팔자를 분석하고, 이를 MBTI와 결합하여 통찰력 있는 조언을 제공하세요.
        말투는 친절하고 전문적이어야 하며, 각 항목당 공백 포함 300자 내외로 작성하세요.
        `;

        const userQuery = `
        아래 정보를 바탕으로 분석해 주세요.
        이름: ${name}, 성별: ${gender}
        생년월일: ${birth_date}, 출생시간: ${birth_time}
        MBTI: ${mbti}

        다음 5가지를 JSON 형식으로 분석해 주세요.
        1. 사주 분석 (saju): 사주팔자의 기운과 특징
        2. MBTI 분석 (mbti): 해당 유형의 성격적 특징
        3. 공통 성향 (trait): 사주와 MBTI가 만났을 때 나타나는 핵심 성향 (결합 분석)
        4. 추천 직업 (jobs): 성향에 맞는 직업군과 이유
        5. 추천 궁합 (match): 잘 맞는 MBTI나 사주 특징

        응답은 오직 JSON 형식이어야 합니다.
        `;

        try {
            const response = await fetch(OPENAI_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${OPENAI_API_KEY}`
                },
                body: JSON.stringify({
                    model: "gpt-3.5-turbo",
                    messages: [
                        { role: "system", content: systemPrompt },
                        { role: "user", content: userQuery }
                    ],
                    response_format: { type: "json_object" },
                    temperature: 0.7,
                    max_tokens: 1500
                })
            });

            const data = await response.json();

            if (data.error) {
                throw new Error(data.error.message);
            }

            const content = JSON.parse(data.choices[0].message.content);
            res.status(200).json(content);

        } catch (error) {
            console.error('API Error:', error);
            res.status(500).json({ error: '분석 중 오류가 발생했습니다.' });
        }
    } else {
        // POST 이외의 요청 거부
        res.status(405).json({ error: 'Method Not Allowed' });
    }
};